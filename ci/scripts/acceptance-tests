#!/bin/bash

set -e
source "${REPO_ROOT}/ci/scripts/functions-ci.sh"
START_DIR="${PWD}"  # Differs for CI and manual execution

if [ -n "$FOCUS" ]; then
  echo "------------------------------------------------------------------"
  echo "FOCUS is set. Will only run tests matching '$FOCUS'"
  echo "Docker won't be stopped afterwards, so you can debug the test."
  echo "------------------------------------------------------------------"
  ADDITIONAL_ARGS=("--focus" "$FOCUS")
fi

git_pull

if [ -f ".git/resource/changed_files" ]; then
  if skip_ci "ci/.ci-ignore" ".git/resource/changed_files"; then
    echo "SKIP TEST: Only .ci-ignored changes found."
    exit 0
  else
    echo "RUN TEST: There is at least one non-ignored change found."
  fi
fi

./ci/scripts/start-bosh.sh

if [ -z "$FOCUS" ]; then
  trap stop_docker EXIT
fi

# shellcheck disable=SC1091
source /tmp/local-bosh/director/env
bosh_release
bosh_assets

cd "acceptance-tests"

echo "----- Installing dependencies"
go mod download
go install github.com/onsi/ginkgo/v2/ginkgo

echo "----- Running tests"

export PATH=$PATH:$GOPATH/bin
ginkgo version
ginkgo -v -p -r --trace --show-node-events --randomize-all --flake-attempts 5 "${ADDITIONAL_ARGS[@]}"
